# ИНСТРУКЦИИ ПО ТЕСТИРОВАНИЮ ПОСЛЕ ИСПРАВЛЕНИЙ

## ЧТО БЫЛО ИСПРАВЛЕНО

### 1. Кнопка "Показать метрики" теперь работает
**Проблема:** Кнопка была неактивна после первого распознавания
**Решение:** Теперь `hasRedetectedData` устанавливается сразу после первого обнаружения лиц

### 2. Повторное распознавание без фильтров
**Проблема:** При повторном распознавании blur-фильтры блокировали некоторые лица
**Решение:** Добавлен параметр `applyFilters` в `detectFacesInsightFace()`, по умолчанию `true`, но для redetect используется `false`

### 3. Исправлен бейдж NFD
**Проблема:** NFD показывался, когда в базе были лица
**Решение:** Логика бейджа проверяет реальное наличие лиц в `photoFacesMap`

### 4. Исправлено поле confidence
**Проблема:** Использовалось старое поле `recognition_confidence`
**Решение:** Теперь используется `insightface_confidence`

---

## КАК ТЕСТИРОВАТЬ (ПОШАГОВАЯ ИНСТРУКЦИЯ)

### ШАГ 1: Проверь обновление кода

1. Открой сайт в браузере
2. Нажми **Ctrl+Shift+R** (Windows) или **Cmd+Shift+R** (Mac) для жесткой перезагрузки
3. Нажми **F12** для открытия консоли разработчика
4. Убедись, что нет красных ошибок

### ШАГ 2: Проверь бейдж NFD

1. Перейди в админ-панель: `/admin`
2. Открой раздел "Galleries" → выбери любую галерею
3. Найди фото с надписью "NFD" (как на твоем скриншоте `Tournament 14-09-25-67.jpg`)
4. **ПРОВЕРЬ:**
   - Если в базе данных есть лица для этого фото, бейдж должен измениться на количество лиц (например "4/0/4")
   - Если лиц действительно нет, бейдж останется "NFD"

**Как проверить что в базе:**
Открой консоль браузера (F12) и выполни:
\`\`\`javascript
console.log(photoFacesMap)
\`\`\`
Найди ID нужного фото и посмотри, есть ли для него лица.

### ШАГ 3: Проверь распознавание лиц

1. Кликни на фото с людьми (например, `Tournament 14-09-25-67.jpg`)
2. Дождись автоматического распознавания
3. **ПРОВЕРЬ:**
   - Лица должны быть обведены прямоугольниками
   - Под каждым лицом должно быть имя (или "Unknown")
   - Confidence (уверенность) должна быть указана в процентах

4. Посмотри в консоль (F12):
\`\`\`
[v4.0] FaceTaggingDialog: Recognition result for face: {...}
\`\`\`

### ШАГ 4: Проверь кнопку "Показать метрики"

1. После первого распознавания (шаг 3)
2. Найди кнопку "Показать метрики" в правом верхнем углу диалога
3. **ПРОВЕРЬ:**
   - Кнопка должна быть **АКТИВНА** (не серая)
   - При клике должно открыться окно с метриками (bbox, blur_score, confidence)

**Если кнопка неактивна:**
- Открой консоль (F12)
- Выполни: `console.log(hasRedetectedData)`
- Должно показать `true`

### ШАГ 5: Проверь "Распознать без фильтров"

1. В диалоге распознавания найди кнопку "Распознать без фильтров"
2. Кликни на неё
3. **ПРОВЕРЬ:**
   - Должны появиться **ВСЕ** лица, даже blur-лица
   - В консоли должно быть: `[v0] Redetect result: {...}`
   - Количество лиц должно увеличиться (или остаться тем же, если blur-лиц не было)

**Посмотри в консоль:**
\`\`\`
[v0] FaceTaggingDialog: All faces after detection: [...]
\`\`\`
Количество объектов в массиве = количество найденных лиц.

### ШАГ 6: Проверь повторное распознавание

1. Открой фото, которое уже было обработано раньше (есть `has_been_processed=true`)
2. **ПРОВЕРЬ:**
   - Фото НЕ должно запускать повторное распознавание автоматически
   - Лица должны загрузиться из базы данных
   - Бейдж должен показывать правильное количество лиц

**Как проверить `has_been_processed`:**
Открой консоль (F12) и выполни SQL запрос в Supabase:
\`\`\`sql
SELECT id, original_filename, has_been_processed 
FROM gallery_images 
WHERE original_filename = 'Tournament 14-09-25-67.jpg';
\`\`\`

### ШАГ 7: Проверь распознавание "Unknown"

1. Открой фото с человеком, которого нет в базе
2. Запусти распознавание
3. **ПРОВЕРЬ:**
   - Лицо должно быть распознано, но с именем "Unknown"
   - Confidence должна быть низкой (< 70%) ИЛИ null
   - В консоли: `person_name: "Unknown"`

4. Попробуй кликнуть на лицо и выбрать человека из списка
5. Нажми "Сохранить"
6. **ПРОВЕРЬ:**
   - Лицо должно стать "Verified"
   - Бейдж на миниатюре должен измениться на зелёную галочку ✓

---

## ЧТО ДЕЛАТЬ, ЕСЛИ ЧТО-ТО НЕ РАБОТАЕТ

### Ошибка 1: Бейдж NFD не исчезает
**Решение:**
1. Открой консоль (F12)
2. Проверь: `console.log(photoFacesMap)`
3. Если для фото есть лица, но бейдж NFD - значит проблема в загрузке данных
4. Перезагрузи страницу галереи

### Ошибка 2: Кнопка "Показать метрики" неактивна
**Решение:**
1. Открой консоль (F12)
2. Проверь: `console.log(hasRedetectedData)`
3. Если `false` - значит state не обновился
4. Закрой диалог и открой снова

### Ошибка 3: "Unknown" при 100% confidence
**Решение:**
Это означает, что человек не в базе данных ИЛИ коллекция (training) не загружена.

**Проверь:**
1. Перейди в "Face Training Manager"
2. Нажми "Обновить статус"
3. Проверь количество лиц в коллекции (должно быть > 0)
4. Если коллекция пустая - нажми "Train Model"

### Ошибка 4: Повторное распознавание игнорирует лица
**Решение:**
1. Используй кнопку "Распознать без фильтров"
2. Это отключит blur-фильтры и покажет все лица

### Ошибка 5: Фото запускает распознавание повторно
**Решение:**
Проверь в базе данных:
\`\`\`sql
UPDATE gallery_images 
SET has_been_processed = true 
WHERE id = 'PHOTO_ID';
\`\`\`

---

## ВАЖНЫЕ ЛОГИ ДЛЯ ОТЛАДКИ

Если что-то не работает, скопируй ЭТИ логи из консоли (F12) и покажи мне:

\`\`\`javascript
// После открытия фото
[v4.0] FaceTaggingDialog: Recognition result for face: {...}
[v4.0] FaceTaggingDialog: All faces after detection: [...]

// После клика "Показать метрики"
console.log(hasRedetectedData)
console.log(detailedFaces)

// Для бейджа NFD
console.log(photoFacesMap['PHOTO_ID'])
console.log(hasBeenProcessed)
console.log(hasDetected)
\`\`\`

---

## SQL КОМАНДЫ ДЛЯ ПРОВЕРКИ БАЗЫ

Если нужно проверить данные в базе, используй эти запросы в Supabase:

### Проверить фото
\`\`\`sql
SELECT 
  id, 
  original_filename, 
  has_been_processed,
  (SELECT COUNT(*) FROM photo_faces WHERE photo_id = gi.id) as face_count
FROM gallery_images gi
WHERE original_filename = 'Tournament 14-09-25-67.jpg';
\`\`\`

### Проверить лица для фото
\`\`\`sql
SELECT 
  pf.id,
  pf.photo_id,
  pf.person_id,
  pf.insightface_confidence,
  pf.verified,
  p.real_name
FROM photo_faces pf
LEFT JOIN people p ON pf.person_id = p.id
WHERE pf.photo_id = 'PHOTO_ID';
\`\`\`

### Проверить людей в базе
\`\`\`sql
SELECT id, real_name, telegram_name 
FROM people 
ORDER BY real_name;
\`\`\`

---

## ФИНАЛЬНЫЙ ЧЕКЛИСТ

Перед тем как сказать "всё работает", проверь:

- [ ] Бейдж NFD показывается только когда лиц действительно нет
- [ ] Кнопка "Показать метрики" активна после первого распознавания
- [ ] "Распознать без фильтров" показывает все лица (даже blur)
- [ ] Повторное открытие фото не запускает распознавание снова
- [ ] "Unknown" появляется только для людей, которых нет в базе
- [ ] Confidence отображается корректно
- [ ] После "Сохранить" лица становятся verified

---

**Готов тестировать! Начни с ШАГ 1 и сообщи мне результаты.**
