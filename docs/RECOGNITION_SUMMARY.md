# ๐ง Face Recognition โ ะัะฐัะบะพะต ัะตะทัะผะต

> **ะะปั:** ะะธะบะพะปะฐะน (ะฒะปะฐะดะตะปะตั ะฟัะพะตะบัะฐ)
> **ะะฑะฝะพะฒะปะตะฝะพ:** 10 ัะฝะฒะฐัั 2026
> **ะะตััะธั ะฐะปะณะพัะธัะผะฐ:** v6.1 (all-faces-indexed)

---

## ะะฐะบ ััะพ ัะฐะฑะพัะฐะตั (ะฟัะพัััะผะธ ัะปะพะฒะฐะผะธ)

\`\`\`
ะคะพัะพ ะทะฐะณััะถะตะฝะพ โ InsightFace ะฝะฐัะพะดะธั ะปะธัะฐ โ ะะฐะถะดะพะต ะปะธัะพ = 512 ัะธัะตะป (ัะผะฑะตะดะดะธะฝะณ)
                                                    โ
                                    ะกัะฐะฒะฝะธะฒะฐะตะผ ั ะธะทะฒะตััะฝัะผะธ ะธะณัะพะบะฐะผะธ (HNSW ะธะฝะดะตะบั)
                                                    โ
                            final_confidence = source_confidence ร similarity
                                                    โ
                            >= 60%? โ ะัะธัะฒะฐะธะฒะฐะตะผ ะธะณัะพะบั
                            < 60%? โ ะะพะบั ัะพััะฐะฝัะตะผ, person_id = NULL
\`\`\`

---

## ะะปััะตะฒัะต ะฟะพะฝััะธั

| ะขะตัะผะธะฝ | ะงัะพ ััะพ | ะะดะต ััะฐะฝะธััั |
|--------|---------|--------------|
| **ะญะผะฑะตะดะดะธะฝะณ** | 512 ัะธัะตะป, ะพะฟะธััะฒะฐััะธั ะปะธัะพ | `photo_faces.insightface_descriptor` |
| **BBox** | ะะพะพัะดะธะฝะฐัั ะปะธัะฐ ะฝะฐ ัะพัะพ | `photo_faces.insightface_bbox` |
| **Face Size** | max(width, height) ะฑะพะบัะฐ | ะััะธัะปัะตััั, ะฝะต ััะฐะฝะธััั |
| **Confidence** | ะฃะฒะตัะตะฝะฝะพััั ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธั (0-1) | `photo_faces.recognition_confidence` |
| **Verified** | ะะพะดัะฒะตัะถะดะตะฝะพ ะฒัััะฝัั | `photo_faces.verified` |
| **Excluded** | ะัะบะปัััะฝ ะธะท ะธะฝะดะตะบัะฐ (outlier) | `photo_faces.excluded_from_index` |

---

## ะะพัะพะณะธ ะธ ัะธะปัััั (v2.3 + v4.2)

### ะะพัะพะณะธ ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธั
| ะะตะถะธะผ | search_threshold | save_threshold | ะะตะทัะปััะฐั |
|-------|------------------|----------------|----------|
| ะก ัะธะปัััะฐะผะธ | 0.60 (config) | 0.60 (config) | ะกัะฐะฝะดะฐััะฝะพะต ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธะต |
| ะะตะท ัะธะปัััะพะฒ | 0.30 | 0.60 (config) | ะะธะดะธะผ ะบะฐะฝะดะธะดะฐัะพะฒ ะฒ top_matches, ะฝะพ ะฝะต ัะพััะฐะฝัะตะผ |

### ะคะธะปัััั ะบะฐัะตััะฒะฐ
| ะคะธะปััั | ะะฝะฐัะตะฝะธะต | ะะฐะบ ัะฐะฑะพัะฐะตั |
|--------|----------|-------------|
| Min Face Size | 80 px | **max(width, height)** >= 80 |
| Min Blur Score | 80 | Laplacian variance |
| Min Detection Score | 0.7 | ะฃะฒะตัะตะฝะฝะพััั InsightFace |

---

## ะะตะนะดะถะธ ะฝะฐ ัะพัะพ (ััะพ ะพะทะฝะฐัะฐัั)

| ะะตะนะดะถ | ะฆะฒะตั | ะงัะพ ััะพ ะทะฝะฐัะธั |
|-------|------|----------------|
| *ะะตะท ะฑะตะนะดะถะฐ* | โ | ะะพะฒะพะต ัะพัะพ, ะตัั ะฝะต ะพะฑัะฐะฑะพัะฐะฝะพ |
| **NFD** | ะกะตััะน | No Faces Detected โ ะปะธั ะฝะต ะฝะฐะนะดะตะฝะพ |
| **2/4** | ะัะฐะฝะถะตะฒัะน | 2 ะฝะตะพะฟะพะทะฝะฐะฝะฝัั ะธะท 4 ะปะธั |
| **75%** | ะกะธะฝะธะน | ะะธะฝะธะผะฐะปัะฝะฐั ัะฒะตัะตะฝะฝะพััั ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธั |
| **โ** | ะะตะปัะฝัะน | ะัะต ะปะธัะฐ ะฟะพะดัะฒะตัะถะดะตะฝั |

---

## HNSW Index (v6.0+)

**ะัะต ะปะธัะฐ ั ะดะตัะบัะธะฟัะพัะฐะผะธ ะฟะพะฟะฐะดะฐัั ะฒ ะธะฝะดะตะบั**, ะฒะบะปััะฐั:
- ะะธัะฐ ะฑะตะท person_id (ะฝะตะธะทะฒะตััะฝัะต)
- ะัะบะปัััะฝะฝัะต ะธะท ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธั (excluded_from_index = true)

\`\`\`
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           HNSW Index                    โ
โ  Face A (person: X, verified: โ)        โ
โ  Face B (person: Y, verified: โ)        โ
โ  Face C (person: null, excluded: โ)     โ โ ะ ะธะฝะดะตะบัะต, ะฝะพ ะฟัะพะฟััะบะฐะตััั
โ  Face D (person: Z, excluded: โ)        โ โ ะ ะธะฝะดะตะบัะต, ะฝะพ ะฟัะพะฟััะบะฐะตััั
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
\`\`\`

**ะัะตะธะผััะตััะฒะฐ:**
- ะะทะผะตะฝะตะฝะธะต person_id ะะ ััะตะฑัะตั rebuild ะธะฝะดะตะบัะฐ
- ะัะฟะพะปัะทัะตััั `update_metadata()` ะฒะผะตััะพ remove+add
- ะะฝะดะตะบั ะพะดะธะฝ ัะฐะท ัััะพะธััั, ะผะตัะฐะดะฐะฝะฝัะต ะพะฑะฝะพะฒะปััััั ะฑััััะพ

---

## ะะปะณะพัะธัะผ ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธั (v6.0 โ Adaptive Early Exit)

\`\`\`python
# ะะปั ะบะฐะถะดะพะณะพ ะบะฐะฝะดะธะดะฐัะฐ ะธะท HNSW (sorted by similarity):
for candidate in index.query(embedding, k=50):
    # v6.0: ะัะพะฟััะบะฐะตะผ ะปะธัะฐ ะฑะตะท person_id ะธะปะธ excluded
    if person_id is None or excluded:
        continue

    final_confidence = source_confidence ร similarity

    # Early exit ะบะพะณะดะฐ:
    if similarity < best_final_confidence:
        break  # ะะฐะปัะฝะตะนัะธะต ะบะฐะฝะดะธะดะฐัั ะฝะต ะผะพะณัั ัะปัััะธัั ัะตะทัะปััะฐั

# ะะดะต source_confidence:
# - Verified face: 1.0
# - Unverified face: recognition_confidence ะธะท ะะ
\`\`\`

**ะัะตะธะผััะตััะฒะฐ:**
- Verified ะปะธัะฐ ะฟัะธะพัะธัะตัะฝะตะต
- ะฆะตะฟะพัะบะธ confidence ะทะฐัััะฐัั ะตััะตััะฒะตะฝะฝะพ
- ะัััััะน ะฒััะพะด ะฑะตะท ะปะธัะฝะธั ะธัะตัะฐัะธะน
- ะะธัะฐ ะฑะตะท person_id ะฒ ะธะฝะดะตะบัะต, ะฝะพ ะฝะต ะผะตัะฐัั ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธั

---

## ะัะพัะตัั ัะฐะฑะพัั ะฐะดะผะธะฝะธัััะฐัะพัะฐ

### 1. ะะฐะณััะทะบะฐ ัะพัะพ
- Drag & Drop ะธะปะธ ะบะฝะพะฟะบะฐ "ะะฐะณััะทะธัั"

### 2. ะะฐะบะตัะฝะพะต ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธะต
- ะะฝะพะฟะบะฐ "ะะฐัะฟะพะทะฝะฐัั ัะพัะพ" ๐
- ะะฐะปะพัะบะฐ "ะัะธะผะตะฝััั ะฝะฐัััะพะนะบะธ ะบะฐัะตััะฒะฐ" (ัะตะบะพะผะตะฝะดัะตััั)

### 3. ะะฐะฑะพัะฐ ั ะฝะตะธะทะฒะตััะฝัะผะธ ะปะธัะฐะผะธ
- ะะฝะพะฟะบะฐ "ะะตะธะทะฒะตััะฝัะต ะปะธัะฐ" ๐ค+
- ะะปะฐััะตัั ะฟะพัะพะถะธั ะปะธั
- ะะตะนััะฒะธั: ัะพะทะดะฐัั ะธะณัะพะบะฐ / ะฒัะฑัะฐัั ัััะตััะฒัััะตะณะพ / ะทัะธัะตะปะธ / ัะดะฐะปะธัั

### 4. ะััะฝะฐั ะฒะตัะธัะธะบะฐัะธั
- ะะปะธะบ ะฝะฐ ัะพัะพ โ ะฒัะฑัะฐัั ะธะณัะพะบะฐ ะดะปั ะบะฐะถะดะพะณะพ ะปะธัะฐ
- ะะพัะปะต ัะพััะฐะฝะตะฝะธั โ ะฑะตะนะดะถ โ

### 5. ะะฐะปะตัะตั ะธะณัะพะบะฐ โ Batch Verify โก NEW
- ะะฝะพะฟะบะฐ "ะะพะดัะฒะตัะดะธัั ะฒัะต ัะพัะพ" โ ะพะดะธะฝ ะทะฐะฟัะพั ะฒะผะตััะพ N
- ะะณะฝะพะฒะตะฝะฝะฐั ะพะฟะตัะฐัะธั ะดะปั ะปัะฑะพะณะพ ะบะพะปะธัะตััะฒะฐ ัะพัะพ

---

## API ัะฝะดะฟะพะธะฝัั (ะบะปััะตะฒัะต)

| ะะตัะพะด | ะญะฝะดะฟะพะธะฝั | ะะฟะธัะฐะฝะธะต | ะะตััะธั |
|-------|----------|----------|--------|
| POST | `/recognition/detect-faces` | ะะตัะตะบัะธั ะปะธั | |
| POST | `/recognition/process-photo` | ะะตัะตะบัะธั + ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธะต | v2.3 |
| POST | `/people/{id}/verify-on-photo` | ะะตัะธัะธะบะฐัะธั ะพะดะฝะพะณะพ | |
| POST | `/people/{id}/batch-verify-on-photos` | Batch ะฒะตัะธัะธะบะฐัะธั | v2.0 NEW |
| GET | `/people/{id}/embedding-consistency` | ะัะดะธั ัะผะฑะตะดะดะธะฝะณะพะฒ | |

---

## ะงะฐัััะต ะฒะพะฟัะพัั

### ะะพัะตะผั ะปะธัะพ ะฝะต ัะฐัะฟะพะทะฝะฐัััั?
1. ะกะปะธัะบะพะผ ะผะฐะปะตะฝัะบะพะต (< 80 px ะฟะพ ะฑะพะปััะตะน ััะพัะพะฝะต)
2. ะะฐะทะผััะพะต (blur < 80)
3. ะะณัะพะบะฐ ะฝะตั ะฒ ะฑะฐะทะต
4. Confidence < 60% (ะฒะธะดะฝะพ ะฒ top_matches, ะฝะพ ะฝะต ัะพััะฐะฝัะตััั)

### ะะพัะตะผั ะฟะพะบะฐะทัะฒะฐะตั ะพะดะฝะพ ัะธัะปะพ, ะฐ ัะธะปััััะตั ะฟะพ ะดััะณะพะผั?
**ะะตัะตะฝะพ ะฒ v4.2:** ะขะตะฟะตัั ะฒะตะทะดะต ะธัะฟะพะปัะทัะตััั max(width, height).

### ะะฐะบ ัะปัััะธัั ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธะต ะธะณัะพะบะฐ?
1. ะะพะดัะฒะตัะดะธัั (verify) ัะพัะพัะธะต ัะพัะพ
2. ะัะบะปััะธัั outliers ัะตัะตะท ะฐัะดะธั ะบะพะฝัะธััะตะฝัะฝะพััะธ
3. ะะฝะดะตะบั ะพะฑะฝะพะฒะปัะตััั ะฐะฒัะพะผะฐัะธัะตัะบะธ

---

## ะััะธัะตะบัััะฐ (ะพัะตะฝั ะบัะฐัะบะพ)

\`\`\`
Frontend (Next.js)
    โ
Server Actions (app/admin/actions/)
    โ
FastAPI (vlcpadel.com:8001)
    โ
Supabase (photo_faces ัะฐะฑะปะธัะฐ)
\`\`\`

---

*ะะพัะปะตะดะฝะตะต ะพะฑะฝะพะฒะปะตะฝะธะต: 10 ัะฝะฒะฐัั 2026*
