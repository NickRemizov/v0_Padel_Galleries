# ИНСТРУКЦИИ ПО ИСПРАВЛЕНИЮ ПРОБЛЕМЫ "Unknown 81%"

## ПРОБЛЕМА
Распознавание возвращает "Unknown" с confidence 81%, хотя человек есть в базе данных.

## ПРИЧИНА
**HNSWLIB index пустой или не загружен** на FastAPI сервере.

Backend использует двухуровневую систему:
1. **Tier 1**: Проверяет verified faces в PostgreSQL (порог 0.60)
2. **Tier 2**: Проверяет unverified faces в HNSWLIB index (порог 0.75)

Если index пустой, распознавание не работает!

---

## РЕШЕНИЕ: ПОШАГОВАЯ ИНСТРУКЦИЯ

### ШАГ 1: Проверь статус index на сервере

1. **Открой терминал** (или SSH к серверу)
2. **Выполни команду**:
   \`\`\`bash
   curl -X GET http://23.88.61.20:8001/api/v2/config
   \`\`\`
3. **Посмотри на результат**:
   \`\`\`json
   {
     "version": "3.31",
     "players_index_size": 0,    // ← ДОЛЖНО БЫТЬ > 0!
     "unique_people": 0,          // ← ДОЛЖНО БЫТЬ > 0!
     ...
   }
   \`\`\`

**ЕСЛИ players_index_size = 0** - index пустой, переходи к Шагу 2!

---

### ШАГ 2: Проверь, есть ли verified лица в базе

1. **Открой pgAdmin** или **psql** на сервере
2. **Выполни SQL запрос**:
   \`\`\`sql
   SELECT COUNT(*) 
   FROM photo_faces 
   WHERE verified = true 
     AND insightface_descriptor IS NOT NULL;
   \`\`\`
3. **Результат должен быть > 0**

**ЕСЛИ результат = 0:**
- Нужно сначала отметить лица как verified в админке
- Открой админ-панель → Gallery Images Manager
- Открой фото с лицами → отметь правильные лица как verified (галочка)
- Повтори запрос

---

### ШАГ 3: Rebuild HNSWLIB index

1. **Выполни команду**:
   \`\`\`bash
   curl -X POST http://23.88.61.20:8001/rebuild-index
   \`\`\`
2. **Дождись ответа** (может занять 10-30 секунд):
   \`\`\`json
   {
     "success": true,
     "old_descriptor_count": 0,
     "new_descriptor_count": 152,   // ← Должно быть > 0!
     "unique_people_count": 47      // ← Количество людей в базе
   }
   \`\`\`

**ЕСЛИ new_descriptor_count = 0:**
- Вернись к Шагу 2 и добавь verified лица

---

### ШАГ 4: Проверь снова статус

1. **Выполни команду**:
   \`\`\`bash
   curl -X GET http://23.88.61.20:8001/api/v2/config
   \`\`\`
2. **Убедись**:
   \`\`\`json
   {
     "players_index_size": 152,     // ← Теперь не 0!
     "unique_people": 47            // ← Есть люди!
   }
   \`\`\`

---

### ШАГ 5: Проверь распознавание

1. **Открой админ-панель** в браузере
2. **Открой галерею** с фотографиями
3. **Открой фото** с лицом, которое должно распознаться
4. **Нажми "Распознать лица"**
5. **Результат**: Теперь должно показывать имя человека, а не "Unknown"!

---

## ЧАСТЫЕ ВОПРОСЫ

### Q: Почему index пустой?
**A:** После изменений в базе (добавление/верификация лиц) нужно вручную перестроить index командой `/rebuild-index`.

### Q: Когда нужно rebuild index?
**A:** После:
- Добавления новых verified лиц
- Верификации ранее unknown лиц
- Удаления людей из базы
- Изменения дескрипторов лиц

### Q: Что делать если rebuild не помогает?
**A:** 
1. Проверь логи FastAPI сервера:
   \`\`\`bash
   journalctl -u galeries-fastapi -n 100 --no-pager
   \`\`\`
2. Ищи строки с `[v0]` - там будет причина
3. Возможно нужно перезапустить FastAPI:
   \`\`\`bash
   sudo systemctl restart galeries-fastapi
   \`\`\`

### Q: Как понизить порог распознавания?
**A:** В коде `python/routers/recognition.py:72` измени:
\`\`\`python
confidence_threshold: float = 0.60  # ← Понизь до 0.50 для менее строгого порога
\`\`\`

---

## ВАЖНО!

Теперь бейджи в галерее работают правильно:
- **✓ (зеленая галочка)** - все лица verified
- **3/2/5 (оранжевый)** - 3 распознано, 2 unknown, 5 всего
- **85% (синий)** - все распознано, среднее confidence 85%
- **NFD (серый)** - No Faces Detected (фото обработано, лиц нет)

Бейджи больше НЕ налезают друг на друга - показывается только один!

---

Если проблема остается - скопируй логи из консоли браузера (F12) и покажи мне.
