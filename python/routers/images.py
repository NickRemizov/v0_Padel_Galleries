"""\nImages API Router\nGallery image management endpoints\n\nv1.1: Migrated to SupabaseService (removed SupabaseDatabase)\n"""\n\nfrom fastapi import APIRouter\nfrom pydantic import BaseModel\nfrom typing import Optional, List\nimport httpx\nimport os\n\nfrom core.responses import ApiResponse\nfrom core.exceptions import NotFoundError, DatabaseError\nfrom core.logging import get_logger\nfrom services.supabase import SupabaseService\nfrom services.face_recognition import FaceRecognitionService\n\nlogger = get_logger(__name__)\nrouter = APIRouter()\n\nsupabase_db: Optional[SupabaseService] = None\nface_service: Optional[FaceRecognitionService] = None\n\n\ndef set_services(db: SupabaseService, face: FaceRecognitionService):\n    \"\"\"Inject services from main.py\"\"\"\n    global supabase_db, face_service\n    supabase_db = db\n    face_service = face\n\n\n# Request/Response Models\n\nclass GalleryImageInput(BaseModel):\n    imageUrl: str\n    originalUrl: str\n    originalFilename: str\n    fileSize: int\n    width: int\n    height: int\n\n\nclass BatchAddImagesRequest(BaseModel):\n    galleryId: str\n    images: List[GalleryImageInput]\n\n\nclass BatchSortOrderItem(BaseModel):\n    id: str\n    order: int\n\n\nclass BatchSortOrderRequest(BaseModel):\n    image_orders: List[BatchSortOrderItem]\n\n\n# Endpoints\n\n@router.get(\"/gallery/{gallery_id}\")\nasync def get_gallery_images(gallery_id: str):\n    \"\"\"Получает все изображения галереи.\"\"\"\n    try:\n        logger.info(f\"Getting images for gallery: {gallery_id}\")\n        \n        result = supabase_db.client.table(\"gallery_images\")\\\n            .select(\"*\")\\\n            .eq(\"gallery_id\", gallery_id)\\\n            .order(\"display_order\")\\\n            .execute()\n        \n        images = result.data or []\n        logger.info(f\"Found {len(images)} images\")\n        return ApiResponse.ok(images)\n        \n    except Exception as e:\n        logger.error(f\"Error getting gallery images: {e}\")\n        raise DatabaseError(str(e), operation=\"get_gallery_images\")\n\n\n@router.patch(\"/gallery/{gallery_id}/sort-order\")\nasync def update_images_sort_order(gallery_id: str, request: BatchSortOrderRequest):\n    \"\"\"Обновляет порядок изображений в галерее.\"\"\"\n    try:\n        logger.info(f\"Updating sort order for gallery {gallery_id}, {len(request.image_orders)} images\")\n        \n        for item in request.image_orders:\n            supabase_db.client.table(\"gallery_images\")\\\n                .update({\"display_order\": item.order})\\\n                .eq(\"id\", item.id)\\\n                .eq(\"gallery_id\", gallery_id)\\\n                .execute()\n        \n        logger.info(\"Sort order updated successfully\")\n        return ApiResponse.ok({\"updated\": True})\n        \n    except Exception as e:\n        logger.error(f\"Error updating sort order: {e}\")\n        raise DatabaseError(str(e), operation=\"update_sort_order\")\n\n\n@router.delete(\"/{image_id}\")\nasync def delete_image(image_id: str):\n    \"\"\"Удаляет фото и все связанные данные.\"\"\"\n    try:\n        logger.info(f\"Deleting image: {image_id}\")\n        \n        # Get image URL for blob deletion\n        result = supabase_db.client.table(\"gallery_images\")\\\n            .select(\"image_url\")\\\n            .eq(\"id\", image_id)\\\n            .execute()\n        \n        if not result.data:\n            raise NotFoundError(\"Image\", image_id)\n        \n        image_url = result.data[0].get(\"image_url\")\n        \n        # Check for descriptors\n        descriptors_result = supabase_db.client.table(\"photo_faces\")\\\n            .select(\"id, insightface_descriptor\")\\\n            .eq(\"photo_id\", image_id)\\\n            .execute()\n        \n        has_descriptors = any(\n            face.get(\"insightface_descriptor\") is not None and face.get(\"insightface_descriptor\") != \"\"\n            for face in (descriptors_result.data or [])\n        )\n        \n        # Delete from DB (CASCADE deletes photo_faces)\n        supabase_db.client.table(\"gallery_images\")\\\n            .delete()\\\n            .eq(\"id\", image_id)\\\n            .execute()\n        \n        logger.info(\"Image deleted from DB\")\n        \n        # Delete blob file\n        if image_url:\n            try:\n                blob_token = os.getenv(\"BLOB_READ_WRITE_TOKEN\")\n                if blob_token and image_url.startswith(\"https://\"):\n                    async with httpx.AsyncClient() as client:\n                        delete_response = await client.delete(\n                            image_url,\n                            headers={\"Authorization\": f\"Bearer {blob_token}\"}\n                        )\n                        if delete_response.status_code in [200, 204]:\n                            logger.info(\"Blob file deleted\")\n            except Exception as e:\n                logger.warning(f\"Failed to delete blob: {e}\")\n        \n        # Rebuild index if had descriptors\n        index_rebuilt = False\n        if has_descriptors:\n            try:\n                rebuild_result = await face_service.rebuild_players_index()\n                if rebuild_result.get(\"success\"):\n                    index_rebuilt = True\n                    logger.info(\"Index rebuilt successfully\")\n            except Exception as e:\n                logger.error(f\"Failed to rebuild index: {e}\")\n        \n        return ApiResponse.ok({\n            \"deleted\": True,\n            \"had_descriptors\": has_descriptors,\n            \"index_rebuilt\": index_rebuilt\n        })\n        \n    except NotFoundError:\n        raise\n    except Exception as e:\n        logger.error(f\"Error deleting image: {e}\")\n        raise DatabaseError(str(e), operation=\"delete_image\")\n\n\n@router.delete(\"/gallery/{gallery_id}/all\")\nasync def delete_all_gallery_images(gallery_id: str):\n    \"\"\"Удаляет все фото из галереи.\"\"\"\n    try:\n        logger.info(f\"Deleting all images from gallery: {gallery_id}\")\n        \n        result = supabase_db.client.table(\"gallery_images\")\\\n            .select(\"id, image_url\")\\\n            .eq(\"gallery_id\", gallery_id)\\\n            .execute()\n        \n        if not result.data:\n            return ApiResponse.ok({\n                \"deleted_count\": 0,\n                \"message\": \"No images to delete\"\n            })\n        \n        images = result.data\n        image_ids = [img[\"id\"] for img in images]\n        \n        # Check for descriptors\n        descriptors_result = supabase_db.client.table(\"photo_faces\")\\\n            .select(\"id, insightface_descriptor\")\\\n            .in_(\"photo_id\", image_ids)\\\n            .execute()\n        \n        has_descriptors = any(\n            face.get(\"insightface_descriptor\") is not None and face.get(\"insightface_descriptor\") != \"\"\n            for face in (descriptors_result.data or [])\n        )\n        \n        # Delete all images\n        deleted_count = 0\n        failed_count = 0\n        \n        for image in images:\n            try:\n                supabase_db.client.table(\"gallery_images\")\\\n                    .delete()\\\n                    .eq(\"id\", image[\"id\"])\\\n                    .execute()\n                deleted_count += 1\n                \n                # Delete blob\n                image_url = image.get(\"image_url\")\n                if image_url:\n                    try:\n                        blob_token = os.getenv(\"BLOB_READ_WRITE_TOKEN\")\n                        if blob_token and image_url.startswith(\"https://\"):\n                            async with httpx.AsyncClient() as client:\n                                await client.delete(\n                                    image_url,\n                                    headers={\"Authorization\": f\"Bearer {blob_token}\"}\n                                )\n                    except Exception:\n                        pass\n                        \n            except Exception as e:\n                logger.error(f\"Failed to delete image {image['id']}: {e}\")\n                failed_count += 1\n        \n        logger.info(f\"Deleted {deleted_count} images, {failed_count} failed\")\n        \n        # Rebuild index if had descriptors\n        index_rebuilt = False\n        if has_descriptors and deleted_count > 0:\n            try:\n                rebuild_result = await face_service.rebuild_players_index()\n                if rebuild_result.get(\"success\"):\n                    index_rebuilt = True\n                    logger.info(\"Index rebuilt successfully\")\n            except Exception as e:\n                logger.error(f\"Failed to rebuild index: {e}\")\n        \n        return ApiResponse.ok({\n            \"deleted_count\": deleted_count,\n            \"failed_count\": failed_count,\n            \"had_descriptors\": has_descriptors,\n            \"index_rebuilt\": index_rebuilt,\n            \"message\": f\"Deleted {deleted_count} images\" + (f\", {failed_count} failed\" if failed_count > 0 else \"\")\n        })\n        \n    except Exception as e:\n        logger.error(f\"Error in batch delete: {e}\")\n        raise DatabaseError(str(e), operation=\"delete_all_gallery_images\")\n\n\n@router.post(\"/batch-add\")\nasync def batch_add_images(request: BatchAddImagesRequest):\n    \"\"\"Добавляет несколько фото в галерею.\"\"\"\n    try:\n        logger.info(f\"Adding {len(request.images)} images to gallery {request.galleryId}\")\n        \n        # Get max display_order\n        max_order_result = supabase_db.client.table(\"gallery_images\")\\\n            .select(\"display_order\")\\\n            .eq(\"gallery_id\", request.galleryId)\\\n            .order(\"display_order\", desc=True)\\\n            .limit(1)\\\n            .execute()\n        \n        start_order = max_order_result.data[0][\"display_order\"] + 1 if max_order_result.data else 0\n        \n        images_to_insert = [\n            {\n                \"gallery_id\": request.galleryId,\n                \"image_url\": img.imageUrl,\n                \"original_url\": img.originalUrl,\n                \"original_filename\": img.originalFilename,\n                \"width\": img.width,\n                \"height\": img.height,\n                \"file_size\": img.fileSize,\n                \"display_order\": start_order + idx\n            }\n            for idx, img in enumerate(request.images)\n        ]\n        \n        result = supabase_db.client.table(\"gallery_images\").insert(images_to_insert).execute()\n        \n        inserted_count = len(result.data) if result.data else 0\n        logger.info(f\"Successfully inserted {inserted_count} images\")\n        \n        return ApiResponse.ok({\n            \"inserted_count\": inserted_count,\n            \"message\": f\"Successfully added {inserted_count} images\"\n        })\n        \n    except Exception as e:\n        logger.error(f\"Error in batch add: {e}\")\n        raise DatabaseError(str(e), operation=\"batch_add_images\")\n\n\n@router.patch(\"/{image_id}/mark-processed\")\nasync def mark_image_as_processed(image_id: str):\n    \"\"\"Помечает фото как обработанное.\"\"\"\n    try:\n        logger.info(f\"Marking image {image_id} as processed\")\n        \n        result = supabase_db.client.table(\"gallery_images\")\\\n            .update({\"has_been_processed\": True})\\\n            .eq(\"id\", image_id)\\\n            .execute()\n        \n        if not result.data:\n            raise NotFoundError(\"Image\", image_id)\n        \n        logger.info(f\"Image {image_id} marked as processed\")\n        return ApiResponse.ok({\"processed\": True})\n        \n    except NotFoundError:\n        raise\n    except Exception as e:\n        logger.error(f\"Error marking image as processed: {e}\")\n        raise DatabaseError(str(e), operation=\"mark_processed\")\n\n\n@router.get(\"/{image_id}/people\")\nasync def get_image_verified_people(image_id: str):\n    \"\"\"Получает список верифицированных людей на фото.\"\"\"\n    try:\n        logger.info(f\"Getting verified people for image: {image_id}\")\n        \n        result = supabase_db.client.table(\"photo_faces\")\\\n            .select(\"person_id, people!inner(id, real_name, telegram_name)\")\\\n            .eq(\"photo_id\", image_id)\\\n            .eq(\"verified\", True)\\\n            .execute()\n        \n        people = []\n        for item in (result.data or []):\n            person_data = item.get(\"people\", {})\n            people.append({\n                \"id\": person_data.get(\"id\"),\n                \"name\": person_data.get(\"real_name\") or person_data.get(\"telegram_name\") or \"Unknown\"\n            })\n        \n        logger.info(f\"Found {len(people)} verified people on image\")\n        return ApiResponse.ok(people)\n        \n    except Exception as e:\n        logger.error(f\"Error getting verified people: {e}\")\n        raise DatabaseError(str(e), operation=\"get_verified_people\")\n