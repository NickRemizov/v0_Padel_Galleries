"""\nGalleries API Router\nCRUD operations for galleries\nSupports both UUID and slug identifiers for human-readable URLs\n\nv1.1: Migrated to SupabaseService (removed SupabaseDatabase)\n"""\n\nfrom fastapi import APIRouter, Query\nfrom pydantic import BaseModel\nfrom typing import Optional, List\n\nfrom core.responses import ApiResponse\nfrom core.exceptions import NotFoundError, ValidationError, DatabaseError\nfrom core.logging import get_logger\nfrom core.slug import resolve_identifier, is_uuid\nfrom services.supabase import SupabaseService\nfrom services.face_recognition import FaceRecognitionService\n\nlogger = get_logger(__name__)\nrouter = APIRouter()\n\nsupabase_db_instance: SupabaseService = None\nface_service_instance: FaceRecognitionService = None\n\n\ndef set_services(supabase_db: SupabaseService, face_service: FaceRecognitionService = None):\n    global supabase_db_instance, face_service_instance\n    supabase_db_instance = supabase_db\n    face_service_instance = face_service\n\n\ndef _resolve_gallery(identifier: str, select: str = \"*\") -> Optional[dict]:\n    \"\"\"Resolve gallery by ID or slug.\"\"\"\n    return resolve_identifier(\n        supabase_db_instance.client,\n        \"galleries\",\n        identifier,\n        slug_column=\"slug\",\n        select=select\n    )\n\n\ndef _get_gallery_id(identifier: str) -> str:\n    \"\"\"Get gallery ID from identifier (ID or slug). Raises NotFoundError if not found.\"\"\"\n    gallery = _resolve_gallery(identifier)\n    if not gallery:\n        raise NotFoundError(\"Gallery\", identifier)\n    return gallery[\"id\"]\n\n\nclass GalleryCreate(BaseModel):\n    title: str\n    shoot_date: str\n    gallery_url: str\n    cover_image_url: str\n    cover_image_square_url: Optional[str] = None\n    external_gallery_url: Optional[str] = None\n    photographer_id: Optional[str] = None\n    location_id: Optional[str] = None\n    organizer_id: Optional[str] = None\n    sort_order: Optional[str] = None\n\n\nclass GalleryUpdate(BaseModel):\n    title: Optional[str] = None\n    shoot_date: Optional[str] = None\n    gallery_url: Optional[str] = None\n    cover_image_url: Optional[str] = None\n    cover_image_square_url: Optional[str] = None\n    external_gallery_url: Optional[str] = None\n    photographer_id: Optional[str] = None\n    location_id: Optional[str] = None\n    organizer_id: Optional[str] = None\n    sort_order: Optional[str] = None\n\n\nclass BatchDeleteImagesRequest(BaseModel):\n    image_ids: List[str]\n    gallery_id: str\n\n\n@router.get(\"\")\nasync def get_galleries(\n    sort_by: str = Query(\"created_at\", enum=[\"created_at\", \"shoot_date\"]),\n    with_relations: bool = Query(True)\n):\n    \"\"\"Get all galleries.\"\"\"\n    try:\n        select = \"*\"\n        if with_relations:\n            select = \"*, photographers(id, name), locations(id, name), organizers(id, name), gallery_images(id)\"\n        \n        result = supabase_db_instance.client.table(\"galleries\").select(select).order(sort_by, desc=True).execute()\n        galleries = result.data or []\n        \n        # Calculate photo_count from gallery_images\n        for gallery in galleries:\n            images = gallery.pop(\"gallery_images\", None)\n            gallery[\"photo_count\"] = len(images) if images else 0\n        \n        return ApiResponse.ok(galleries)\n    except Exception as e:\n        logger.error(f\"Error getting galleries: {e}\")\n        raise DatabaseError(str(e), operation=\"get_galleries\")\n\n\n@router.get(\"/with-unprocessed-photos\")\nasync def get_galleries_with_unprocessed_photos():\n    \"\"\"Get galleries that have unprocessed photos (has_been_processed = false or null).\"\"\"\n    try:\n        # Get all galleries\n        galleries_result = supabase_db_instance.client.table(\"galleries\").select(\n            \"id, title, shoot_date, slug\"\n        ).order(\"shoot_date\", desc=True).execute()\n        \n        galleries = galleries_result.data or []\n        if not galleries:\n            return ApiResponse.ok([])\n        \n        result = []\n        for gallery in galleries:\n            # Total photos count\n            total_result = supabase_db_instance.client.table(\"gallery_images\").select(\n                \"id\", count=\"exact\"\n            ).eq(\"gallery_id\", gallery[\"id\"]).execute()\n            total_count = total_result.count or 0\n            \n            # Unprocessed photos count (has_been_processed = false or null)\n            unprocessed_result = supabase_db_instance.client.table(\"gallery_images\").select(\n                \"id\", count=\"exact\"\n            ).eq(\"gallery_id\", gallery[\"id\"]).or_(\n                \"has_been_processed.is.null,has_been_processed.eq.false\"\n            ).execute()\n            unprocessed_count = unprocessed_result.count or 0\n            \n            if unprocessed_count > 0:\n                result.append({\n                    \"id\": gallery[\"id\"],\n                    \"slug\": gallery.get(\"slug\"),\n                    \"title\": gallery[\"title\"],\n                    \"shoot_date\": gallery[\"shoot_date\"],\n                    \"total_photos\": total_count,\n                    \"unprocessed_photos\": unprocessed_count\n                })\n        \n        logger.info(f\"Found {len(result)} galleries with unprocessed photos\")\n        return ApiResponse.ok(result)\n    except Exception as e:\n        logger.error(f\"Error getting galleries with unprocessed photos: {e}\")\n        raise DatabaseError(str(e), operation=\"get_galleries_with_unprocessed_photos\")\n\n\n@router.get(\"/with-unverified-faces\")\nasync def get_galleries_with_unverified_faces():\n    \"\"\"\n    Get galleries that have photos NOT fully verified.\n    A photo is fully verified ONLY if ALL its faces have recognition_confidence = 1.\n    Photos with no faces or with any face having confidence != 1 are unverified.\n    \"\"\"\n    try:\n        # Get all galleries\n        galleries_result = supabase_db_instance.client.table(\"galleries\").select(\n            \"id, title, shoot_date, slug\"\n        ).order(\"shoot_date\", desc=True).execute()\n        \n        galleries = galleries_result.data or []\n        if not galleries:\n            return ApiResponse.ok([])\n        \n        result = []\n        for gallery in galleries:\n            # Get all photos in gallery\n            photos_result = supabase_db_instance.client.table(\"gallery_images\").select(\n                \"id\"\n            ).eq(\"gallery_id\", gallery[\"id\"]).execute()\n            \n            photos = photos_result.data or []\n            if not photos:\n                continue\n            \n            total_count = len(photos)\n            photo_ids = [p[\"id\"] for p in photos]\n            \n            # Get ALL faces for these photos\n            all_faces_result = supabase_db_instance.client.table(\"photo_faces\").select(\n                \"photo_id, recognition_confidence\"\n            ).in_(\"photo_id\", photo_ids).execute()\n            \n            all_faces = all_faces_result.data or []\n            \n            # Build map: photo_id -> list of faces\n            faces_by_photo = {}\n            for face in all_faces:\n                pid = face[\"photo_id\"]\n                if pid not in faces_by_photo:\n                    faces_by_photo[pid] = []\n                faces_by_photo[pid].append(face)\n            \n            # Find fully verified photos (ALL faces have confidence = 1)\n            fully_verified_photo_ids = set()\n            for photo_id, faces in faces_by_photo.items():\n                # Photo is fully verified only if it has faces AND all have confidence = 1\n                if len(faces) > 0 and all(f.get(\"recognition_confidence\") == 1 for f in faces):\n                    fully_verified_photo_ids.add(photo_id)\n            \n            # Unverified = all photos - fully verified\n            unverified_count = total_count - len(fully_verified_photo_ids)\n            \n            if unverified_count > 0:\n                result.append({\n                    \"id\": gallery[\"id\"],\n                    \"slug\": gallery.get(\"slug\"),\n                    \"title\": gallery[\"title\"],\n                    \"shoot_date\": gallery[\"shoot_date\"],\n                    \"total_photos\": total_count,\n                    \"unverified_photos\": unverified_count\n                })\n        \n        logger.info(f\"Found {len(result)} galleries with unverified faces\")\n        return ApiResponse.ok(result)\n    except Exception as e:\n        logger.error(f\"Error getting galleries with unverified faces: {e}\")\n        raise DatabaseError(str(e), operation=\"get_galleries_with_unverified_faces\")\n\n\n# Keep old endpoint for backward compatibility\n@router.get(\"/with-unrecognized-faces\")\nasync def get_galleries_with_unrecognized_faces():\n    \"\"\"Alias for with-unverified-faces (backward compatibility).\"\"\"\n    return await get_galleries_with_unverified_faces()\n\n\n@router.get(\"/{identifier}\")\nasync def get_gallery(identifier: str):\n    \"\"\"Get a gallery by ID or slug.\"\"\"\n    try:\n        gallery = _resolve_gallery(\n            identifier,\n            select=\"*, photographers(id, name), locations(id, name), organizers(id, name)\"\n        )\n        \n        if gallery:\n            # Add photo count\n            count_result = supabase_db_instance.client.table(\"gallery_images\").select(\n                \"id\", count=\"exact\"\n            ).eq(\"gallery_id\", gallery[\"id\"]).execute()\n            gallery[\"photo_count\"] = count_result.count or 0\n            \n            return ApiResponse.ok(gallery)\n        raise NotFoundError(\"Gallery\", identifier)\n    except NotFoundError:\n        raise\n    except Exception as e:\n        logger.error(f\"Error getting gallery {identifier}: {e}\")\n        raise DatabaseError(str(e), operation=\"get_gallery\")\n\n\n@router.get(\"/{identifier}/unprocessed-photos\")\nasync def get_gallery_unprocessed_photos(identifier: str):\n    \"\"\"Get unprocessed photos from a gallery for recognition.\"\"\"\n    try:\n        gallery_id = _get_gallery_id(identifier)\n        \n        result = supabase_db_instance.client.table(\"gallery_images\").select(\n            \"id, image_url, original_filename, slug\"\n        ).eq(\"gallery_id\", gallery_id).or_(\n            \"has_been_processed.is.null,has_been_processed.eq.false\"\n        ).order(\"original_filename\").execute()\n        \n        images = result.data or []\n        logger.info(f\"Found {len(images)} unprocessed photos in gallery {gallery_id}\")\n        return ApiResponse.ok(images)\n    except NotFoundError:\n        raise\n    except Exception as e:\n        logger.error(f\"Error getting unprocessed photos for gallery {identifier}: {e}\")\n        raise DatabaseError(str(e), operation=\"get_gallery_unprocessed_photos\")\n\n\n@router.get(\"/{identifier}/unverified-photos\")\nasync def get_gallery_unverified_photos(identifier: str):\n    \"\"\"\n    Get photos from a gallery that are NOT fully verified.\n    A photo is fully verified ONLY if ALL its faces have recognition_confidence = 1.\n    \"\"\"\n    try:\n        gallery_id = _get_gallery_id(identifier)\n        \n        # Get all photos in gallery\n        photos_result = supabase_db_instance.client.table(\"gallery_images\").select(\n            \"id, image_url, original_filename, slug\"\n        ).eq(\"gallery_id\", gallery_id).order(\"original_filename\").execute()\n        \n        photos = photos_result.data or []\n        if not photos:\n            return ApiResponse.ok([])\n        \n        photo_ids = [p[\"id\"] for p in photos]\n        \n        # Get ALL faces for these photos\n        all_faces_result = supabase_db_instance.client.table(\"photo_faces\").select(\n            \"photo_id, recognition_confidence\"\n        ).in_(\"photo_id\", photo_ids).execute()\n        \n        all_faces = all_faces_result.data or []\n        \n        # Build map: photo_id -> list of faces\n        faces_by_photo = {}\n        for face in all_faces:\n            pid = face[\"photo_id\"]\n            if pid not in faces_by_photo:\n                faces_by_photo[pid] = []\n            faces_by_photo[pid].append(face)\n        \n        # Find fully verified photos (ALL faces have confidence = 1)\n        fully_verified_photo_ids = set()\n        for photo_id, faces in faces_by_photo.items():\n            if len(faces) > 0 and all(f.get(\"recognition_confidence\") == 1 for f in faces):\n                fully_verified_photo_ids.add(photo_id)\n        \n        # Return photos that are NOT fully verified\n        result = [p for p in photos if p[\"id\"] not in fully_verified_photo_ids]\n        \n        logger.info(f\"Found {len(result)} unverified photos in gallery {gallery_id}\")\n        return ApiResponse.ok(result)\n    except NotFoundError:\n        raise\n    except Exception as e:\n        logger.error(f\"Error getting unverified photos for gallery {identifier}: {e}\")\n        raise DatabaseError(str(e), operation=\"get_gallery_unverified_photos\")\n\n\n# Keep old endpoint for backward compatibility\n@router.get(\"/{identifier}/unrecognized-photos\")\nasync def get_gallery_unrecognized_photos(identifier: str):\n    \"\"\"Alias for unverified-photos (backward compatibility).\"\"\"\n    return await get_gallery_unverified_photos(identifier)\n\n\n@router.get(\"/{identifier}/stats\")\nasync def get_gallery_stats(identifier: str):\n    \"\"\"Get face recognition stats for a gallery.\n    \n    Photo is verified if:\n    - It has NO faces (no faces = nothing to verify = verified)\n    - OR ALL its faces have verified=True\n    \n    Photo is NOT verified if:\n    - It has at least one face with verified=False\n    \"\"\"\n    try:\n        gallery_id = _get_gallery_id(identifier)\n        \n        images_result = supabase_db_instance.client.table(\"gallery_images\").select(\"id\").eq(\"gallery_id\", gallery_id).execute()\n        image_ids = [img[\"id\"] for img in (images_result.data or [])]\n        \n        if not image_ids:\n            return ApiResponse.ok({\n                \"isFullyVerified\": True,  # No photos = nothing to verify\n                \"verifiedCount\": 0,\n                \"totalCount\": 0\n            })\n        \n        # Get ALL faces for these photos (not just verified ones)\n        faces_result = supabase_db_instance.client.table(\"photo_faces\").select(\n            \"photo_id, verified\"\n        ).in_(\"photo_id\", image_ids).execute()\n        \n        all_faces = faces_result.data or []\n        \n        # Group faces by photo_id\n        faces_by_photo = {}\n        for face in all_faces:\n            pid = face[\"photo_id\"]\n            if pid not in faces_by_photo:\n                faces_by_photo[pid] = []\n            faces_by_photo[pid].append(face)\n        \n        # Count verified photos\n        # Photo is verified if: no faces OR all faces verified=True\n        verified_count = 0\n        for photo_id in image_ids:\n            faces = faces_by_photo.get(photo_id, [])\n            if len(faces) == 0:\n                # No faces = verified (nothing to verify)\n                verified_count += 1\n            elif all(f.get(\"verified\", False) for f in faces):\n                # All faces verified\n                verified_count += 1\n        \n        total_count = len(image_ids)\n        is_fully_verified = verified_count == total_count and total_count > 0\n        \n        return ApiResponse.ok({\n            \"isFullyVerified\": is_fully_verified,\n            \"verifiedCount\": verified_count,\n            \"totalCount\": total_count\n        })\n    except NotFoundError:\n        raise\n    except Exception as e:\n        logger.error(f\"Error getting gallery stats {identifier}: {e}\")\n        raise DatabaseError(str(e), operation=\"get_gallery_stats\")\n\n\n@router.post(\"\")\nasync def create_gallery(data: GalleryCreate):\n    \"\"\"Create a new gallery.\"\"\"\n    try:\n        insert_data = data.model_dump(exclude_none=True)\n        result = supabase_db_instance.client.table(\"galleries\").insert(insert_data).execute()\n        if result.data:\n            logger.info(f\"Created gallery: {data.title}\")\n            return ApiResponse.ok(result.data[0])\n        raise DatabaseError(\"Insert failed\", operation=\"create_gallery\")\n    except Exception as e:\n        logger.error(f\"Error creating gallery: {e}\")\n        raise DatabaseError(str(e), operation=\"create_gallery\")\n\n\n@router.put(\"/{identifier}\")\nasync def update_gallery(identifier: str, data: GalleryUpdate):\n    \"\"\"Update a gallery by ID or slug.\"\"\"\n    try:\n        gallery_id = _get_gallery_id(identifier)\n        \n        update_data = data.model_dump(exclude_none=True)\n        if not update_data:\n            raise ValidationError(\"No fields to update\")\n        \n        result = supabase_db_instance.client.table(\"galleries\").update(update_data).eq(\"id\", gallery_id).execute()\n        if result.data:\n            logger.info(f\"Updated gallery {gallery_id}\")\n            return ApiResponse.ok(result.data[0])\n        raise NotFoundError(\"Gallery\", identifier)\n    except (NotFoundError, ValidationError):\n        raise\n    except Exception as e:\n        logger.error(f\"Error updating gallery {identifier}: {e}\")\n        raise DatabaseError(str(e), operation=\"update_gallery\")\n\n\n@router.patch(\"/{identifier}/sort-order\")\nasync def update_sort_order(identifier: str, sort_order: str = Query(...)):\n    \"\"\"Update gallery sort order.\"\"\"\n    try:\n        gallery_id = _get_gallery_id(identifier)\n        \n        supabase_db_instance.client.table(\"galleries\").update({\"sort_order\": sort_order}).eq(\"id\", gallery_id).execute()\n        logger.info(f\"Updated sort order for gallery {gallery_id}\")\n        return ApiResponse.ok({\"updated\": True})\n    except NotFoundError:\n        raise\n    except Exception as e:\n        logger.error(f\"Error updating sort order: {e}\")\n        raise DatabaseError(str(e), operation=\"update_sort_order\")\n\n\n@router.post(\"/batch-delete-images\")\nasync def batch_delete_gallery_images(data: BatchDeleteImagesRequest):\n    \"\"\"\n    Batch delete multiple images from a gallery.\n    Uses POST method because DELETE with body is unreliable.\n    Performance: O(1) instead of O(n) - single query per operation, single index rebuild.\n    \"\"\"\n    try:\n        image_ids = data.image_ids\n        gallery_id = data.gallery_id\n        \n        if not image_ids:\n            return ApiResponse.ok({\n                \"deleted_count\": 0,\n                \"had_verified_faces\": False,\n                \"index_rebuilt\": False\n            })\n        \n        logger.info(f\"Batch deleting {len(image_ids)} images from gallery {gallery_id}\")\n        \n        # Step 1: Check if ANY images have verified faces (single query)\n        verified_check = supabase_db_instance.client.table(\"photo_faces\").select(\n            \"id\", count=\"exact\"\n        ).in_(\"photo_id\", image_ids).eq(\"verified\", True).execute()\n        \n        had_verified_faces = (verified_check.count or 0) > 0\n        \n        # Step 2: Delete all photo_faces for these images (single query)\n        supabase_db_instance.client.table(\"photo_faces\").delete().in_(\"photo_id\", image_ids).execute()\n        \n        # Step 3: Delete all images (single query)\n        delete_result = supabase_db_instance.client.table(\"gallery_images\").delete().in_(\n            \"id\", image_ids\n        ).eq(\"gallery_id\", gallery_id).execute()\n        \n        deleted_count = len(delete_result.data) if delete_result.data else 0\n        logger.info(f\"Deleted {deleted_count} images from gallery {gallery_id}\")\n        \n        # Step 4: Rebuild index ONCE if any verified faces existed\n        index_rebuilt = False\n        if had_verified_faces and face_service_instance:\n            try:\n                await face_service_instance.rebuild_players_index()\n                index_rebuilt = True\n                logger.info(f\"Rebuilt players index after batch delete\")\n            except Exception as e:\n                logger.error(f\"Failed to rebuild index after batch delete: {e}\")\n        \n        return ApiResponse.ok({\n            \"deleted_count\": deleted_count,\n            \"had_verified_faces\": had_verified_faces,\n            \"index_rebuilt\": index_rebuilt\n        })\n    except Exception as e:\n        logger.error(f\"Error batch deleting images: {e}\")\n        raise DatabaseError(str(e), operation=\"batch_delete_gallery_images\")\n\n\n@router.delete(\"/{identifier}\")\nasync def delete_gallery(identifier: str, delete_images: bool = Query(True)):\n    \"\"\"Delete a gallery and optionally all its images.\"\"\"\n    try:\n        gallery_id = _get_gallery_id(identifier)\n        \n        if delete_images:\n            # Get all images in gallery\n            images = supabase_db_instance.client.table(\"gallery_images\").select(\"id\").eq(\"gallery_id\", gallery_id).execute()\n            image_ids = [img[\"id\"] for img in (images.data or [])]\n            \n            if image_ids:\n                # Delete photo_faces for all images (single query)\n                supabase_db_instance.client.table(\"photo_faces\").delete().in_(\"photo_id\", image_ids).execute()\n                \n                # Delete all images\n                supabase_db_instance.client.table(\"gallery_images\").delete().eq(\"gallery_id\", gallery_id).execute()\n                logger.info(f\"Deleted {len(image_ids)} images from gallery {gallery_id}\")\n        \n        # Delete gallery\n        supabase_db_instance.client.table(\"galleries\").delete().eq(\"id\", gallery_id).execute()\n        logger.info(f\"Deleted gallery {gallery_id}\")\n        \n        # Rebuild face recognition index to remove stale embeddings\n        index_rebuilt = False\n        if face_service_instance:\n            try:\n                await face_service_instance.rebuild_players_index()\n                index_rebuilt = True\n                logger.info(f\"Rebuilt players index after deleting gallery {gallery_id}\")\n            except Exception as e:\n                logger.error(f\"Failed to rebuild index after gallery deletion: {e}\")\n        \n        return ApiResponse.ok({\"deleted\": True, \"index_rebuilt\": index_rebuilt})\n    except NotFoundError:\n        raise\n    except Exception as e:\n        logger.error(f\"Error deleting gallery {identifier}: {e}\")\n        raise DatabaseError(str(e), operation=\"delete_gallery\")\n