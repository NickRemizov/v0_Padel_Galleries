#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è –¥–ª—è Galeries Backend
# –°–ª–µ–¥–∏—Ç –∑–∞ –ø–æ—è–≤–ª–µ–Ω–∏–µ–º galeries.zip –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç

WATCH_DIR="/home/nickr"
WATCH_FILE="galeries.zip"
DEPLOY_LOG="/home/nickr/auto-deploy.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$DEPLOY_LOG"
}

deploy() {
    log "=========================================="
    log "üöÄ –û–±–Ω–∞—Ä—É–∂–µ–Ω —Ñ–∞–π–ª $WATCH_FILE, –Ω–∞—á–∏–Ω–∞—é –¥–µ–ø–ª–æ–π..."
    log "=========================================="
    
    cd "$WATCH_DIR" || { log "‚ùå –ù–µ –º–æ–≥—É –ø–µ—Ä–µ–π—Ç–∏ –≤ $WATCH_DIR"; return 1; }
    
    # –®–∞–≥ 1: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
    log "[1/5] –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞..."
    if [ -f "python/stop.sh" ]; then
        cd python && ./stop.sh >> "$DEPLOY_LOG" 2>&1
        cd ..
        log "  ‚úì –°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    else
        log "  ‚ö†Ô∏è  –°–∫—Ä–∏–ø—Ç stop.sh –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞—é"
    fi
    
    # –®–∞–≥ 2: –ë—ç–∫–∞–ø —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏
    log "[2/5] –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞..."
    if [ -d "python" ]; then
        BACKUP_NAME="python_backup_$(date +%Y%m%d_%H%M%S)"
        mv python "$BACKUP_NAME"
        log "  ‚úì –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: $BACKUP_NAME"
    fi
    
    # –®–∞–≥ 3: –†–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ
    log "[3/5] –†–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ $WATCH_FILE..."
    unzip -o "$WATCH_FILE" >> "$DEPLOY_LOG" 2>&1
    if [ $? -eq 0 ]; then
        log "  ‚úì –§–∞–π–ª—ã —Ä–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω—ã"
    else
        log "  ‚ùå –û—à–∏–±–∫–∞ —Ä–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è!"
        # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–∞
        if [ -d "$BACKUP_NAME" ]; then
            mv "$BACKUP_NAME" python
            log "  ‚Ü©Ô∏è  –ë—ç–∫–∞–ø –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        fi
        return 1
    fi
    
    # –®–∞–≥ 4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞
    log "[4/5] –ó–∞–ø—É—Å–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏..."
    if [ -f "SETUP.sh" ]; then
        chmod +x SETUP.sh
        ./SETUP.sh >> "$DEPLOY_LOG" 2>&1
        if [ $? -eq 0 ]; then
            log "  ‚úì –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
        else
            log "  ‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏!"
            return 1
        fi
    else
        log "  ‚ö†Ô∏è  SETUP.sh –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞—é —É—Å—Ç–∞–Ω–æ–≤–∫—É"
    fi
    
    # –®–∞–≥ 5: –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
    log "[5/5] –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞..."
    if [ -f "python/start-daemon.sh" ]; then
        cd python && ./start-daemon.sh >> "$DEPLOY_LOG" 2>&1
        if [ $? -eq 0 ]; then
            log "  ‚úì –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω"
        else
            log "  ‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞!"
            cd ..
            return 1
        fi
        cd ..
    else
        log "  ‚ùå start-daemon.sh –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        return 1
    fi
    
    # –®–∞–≥ 6: –£–¥–∞–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞
    log "[6/6] –£–¥–∞–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞..."
    rm -f "$WATCH_FILE"
    log "  ‚úì –ê—Ä—Ö–∏–≤ —É–¥–∞–ª–µ–Ω"
    
    log "=========================================="
    log "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
    log "=========================================="
    log ""
    
    # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3)
    log "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤..."
    ls -dt python_backup_* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null
    log "  ‚úì –°—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã —É–¥–∞–ª–µ–Ω—ã"
    log ""
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –æ—Ç root
if [ "$EUID" -ne 0 ]; then 
    echo "‚ùå –û–®–ò–ë–ö–ê: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å sudo"
    echo "   sudo ./auto-deploy.sh"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è inotify-tools
if ! command -v inotifywait &> /dev/null; then
    log "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ inotify-tools..."
    apt-get update -qq
    apt-get install -y inotify-tools
    log "  ‚úì inotify-tools —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

log "üëÄ –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ $WATCH_DIR/$WATCH_FILE"
log "   –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
log ""

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
while true; do
    # –ñ–¥–µ–º –ø–æ—è–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞
    inotifywait -q -e create,moved_to "$WATCH_DIR" 2>/dev/null | while read -r directory event filename; do
        if [ "$filename" = "$WATCH_FILE" ]; then
            # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ —á—Ç–æ–±—ã —Ñ–∞–π–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª—Å—è
            sleep 2
            deploy
        fi
    done
done
